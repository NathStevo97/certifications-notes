# 3.23 - Cluster Upgrade Process

- The kubernetes components don't all have to be at the same versions
  - No component should be at a version higher than the kube-api server
  - If Kube-API Server is version X (a minor release), then the following ranges apply for the other components for support level:
    - **Controller manager:** X-1
    - **Kube-Scheduler:** X-1
    - **Kubelet:** X-2
    - **Kube-Proxy:** X-2
    - **Kubectl:** X-1 - X+1
- At any point, Kubernetes only supports the 3 most recent minor releases e.g. 1.19 - 1.17
- It's better to **upgrade iteratively** over minor releases e.g. 1.17 - 1.18 and so on
- Upgrade process = **Cluster-Dependent**
- If on a cloud provider, built-in functionality available
- If on kubeadm/manually created cluster, must use commands:
  - `kubeadm upgrade plan`
  - `kubeadm upgrade apply`
- Cluster upgrades involve two steps:
  - **Upgrade the master node**
    - All management components go down temporarily during the processes
    - Doesn't impact the current node workloads (only if you try to do anything with them)
  - **Upgrade the worker nodes**
    - Can be done all at once - Results in downtime
    - Can be done iteratively - Minimal downtime by draining nodes as they get upgraded one after another
    - Could also add new nodes with the most recent software versions
      - Proves especially inconvenient when on a cloud provider
- **Upgrading via Kubeadm:**
  - `kubeadm upgrade plan`
    - Lists latest versions available
    - Components that must be upgraded manually
    - Command to upgrade kubeadm
  - **Note:** kubeadm itself must be upgraded first: `apt-get upgrade -y kubeadm=major.minor.patch_min-patch_max`
- Check upgrade success based on CLI output and kubectl get nodes
- If Kubelet is running on Master node, this must be upgraded next the master node and restart the service:
  - `apt-get upgrade -y kubelet=1.12.0-00`
  - `systemctl restart kubelet`
- Upgrading the worker nodes:
  - Use the drain command to stop and transfer the current workloads to other nodes: `kubectl drain <node>`, then upgrade the following for each node (ssh into each one):
    - **Kubeadm** - `apt-get upgrade -y kubeadm=major.minor.patch_min-patch_max`
    - **Kubelet** - `apt-get upgrade -y kubelet=major.minor.patch_min-patch_max`
    - **Node config:** - `kubeadm upgrade node config --kubelet-version major.minor.patch`
  - **Restart the service:** `systemctl restart kubelet`
- Make sure to uncordon each node after each upgrade! `kubectl uncordon <node>`
- Instructions Available Here: [Upgrade A Cluster | Kubernetes](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)